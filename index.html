<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SILENT PENGUIN</title>
    <link rel="icon" href="favicon.png" type="image/png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        .card-shadow {
            box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.3);
        }

        .selected {
            transform: translateY(-15px);
            box-shadow: 0 0 15px yellow;
            border: 2px solid yellow;
            z-index: 50;
        }

        .valid-zone {
            border: 3px dashed rgba(255, 255, 255, 0.4);
            background-color: rgba(255, 255, 255, 0.1);
            animation: pulse 1.5s infinite;
        }



        .title-logo {
            text-shadow: 0px 0px 20px rgba(34, 211, 238, 0.2);
            letter-spacing: 0.1em;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slide-up {
            0% {
                transform: translateY(100px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes text-pop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fade-out {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .animate-bounce-in {
            animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }

        .animate-text-pop {
            animation: text-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes pop-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            70% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes wave {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        @keyframes jump {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            25% {
                transform: translateY(-20px) rotate(-10deg);
            }

            75% {
                transform: translateY(-10px) rotate(10deg);
            }
        }

        .animate-pop-in {
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .animate-wave {
            animation: wave 1.5s ease-in-out infinite;
        }

        .animate-float {
            animation: float 2s ease-in-out infinite;
        }

        .animate-jump {
            animation: jump 0.8s ease-in-out infinite;
        }

        .ThinkingBubble {
            position: absolute;
            background: white;
            border-radius: 50%;
            padding: 2px 8px;
            color: black;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 20;
        }

        .ThinkingBubble::before {
            content: "";
            position: absolute;
            bottom: -4px;
            left: 10px;
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: white transparent;
        }

        .grid-cell {
            flex-shrink: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #0f172a;
            color: white;
            user-select: none;
            touch-action: manipulation;
        }
    </style>
</head>

<body class="min-h-screen overflow-hidden bg-gradient-to-b from-slate-900 to-slate-800">
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ÂÆöÊï∞ ---
        const COLORS = {
            Green: { bg: 'bg-green-500', text: 'text-green-500', count: 8, label: 'Á∑ë', icon: '‚ô£' },
            Red: { bg: 'bg-red-500', text: 'text-red-500', count: 7, label: 'Ëµ§', icon: '‚ô•' },
            Blue: { bg: 'bg-blue-500', text: 'text-blue-500', count: 7, label: 'Èùí', icon: '‚ô¶' },
            Yellow: { bg: 'bg-yellow-400', text: 'text-yellow-400', count: 7, label: 'ÈªÑ', icon: '‚òÖ' },
            Purple: { bg: 'bg-purple-500', text: 'text-purple-500', count: 7, label: 'Á¥´', icon: '‚ô†' },
        };
        const DIFFICULTIES = {
            easy: { label: 'EASY', color: 'text-green-400', desc: 'Random Moves' },
            normal: { label: 'NORMAL', color: 'text-yellow-400', desc: 'Balanced Strategy' },
            hard: { label: 'HARD', color: 'text-red-500', desc: 'Aggressive' },
        };
        const PYRAMID_ROWS = 7;
        const BASE_WIDTH_LIMIT = 7;
        const INTERNAL_BASE_SIZE = 13;
        const BASE_ROW_INDEX = 6;
        const LOSE_THRESHOLD = 10;

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        const getStats = () => {
            const saved = localStorage.getItem('silent_penguin_stats');
            return saved ? JSON.parse(saved) : {
                easy: { wins: 0, losses: 0, draws: 0 },
                normal: { wins: 0, losses: 0, draws: 0 },
                hard: { wins: 0, losses: 0, draws: 0 }
            };
        };
        const saveGameResult = (difficulty, result) => {
            const stats = getStats();
            if (stats[difficulty]) {
                stats[difficulty][result === 'win' ? 'wins' : (result === 'loss' ? 'losses' : 'draws')]++;
                localStorage.setItem('silent_penguin_stats', JSON.stringify(stats));
            }
        };
        const clearStats = () => localStorage.removeItem('silent_penguin_stats');

        const triggerConfetti = () => {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            var random = (min, max) => Math.random() * (max - min) + min;
            var interval = setInterval(function () {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        };

        // --- Common Components ---
        const Card = ({ color, className = "" }) => (
            <div className={`w-8 h-10 sm:w-10 sm:h-12 rounded border-2 border-white flex items-center justify-center ${COLORS[color].bg} shadow-sm ${className}`}>
                <span className="text-white drop-shadow-md text-sm font-bold">{COLORS[color].icon}</span>
            </div>
        );

        const Button = ({ onClick, children, className = "", ...props }) => {
            const baseStyle = "font-bold py-3 px-6 rounded-lg shadow-lg hover:scale-105 transition tracking-widest";
            return (
                <button onClick={onClick} className={`${baseStyle} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const ChipView = ({ count, label, isDanger, isActive, handCount, isCpu, isPassed }) => (
            <div className={`relative transition-all duration-300 rounded-lg p-0.5 ${isActive ? 'bg-gradient-to-r from-yellow-300 to-yellow-500 shadow-[0_0_15px_rgba(253,224,71,0.5)] scale-105' : 'bg-transparent'}`}>
                {/* Thinking Bubble for CPU */}
                {isActive && isCpu && <div className="absolute -top-3 -right-3 animate-float ThinkingBubble text-xs">üí≠</div>}

                <div className={`flex flex-col items-center px-3 py-1.5 rounded-lg min-w-[7rem] ${isDanger ? 'bg-red-900/40 border border-red-500' : (isActive ? 'bg-slate-800' : 'bg-slate-900/50')}`}>
                    <div className={`text-xs font-bold mb-1 tracking-wider ${isActive ? 'text-yellow-400' : 'text-slate-400'}`}>{isActive ? 'TURN' : label}</div>

                    <div className="flex gap-4 items-center justify-center w-full">
                        {/* Life / Chips */}
                        <div className="flex flex-col items-center">
                            <div className="text-[10px] text-slate-500 font-bold uppercase">PTS</div>
                            <div className="text-xl font-black flex items-baseline gap-0.5">
                                <span className="text-cyan-400">{count}</span>
                                <span className="text-[10px] font-normal opacity-40">/{LOSE_THRESHOLD}</span>
                            </div>
                        </div>

                        <div className="w-px h-6 bg-slate-700"></div>

                        {/* Hand Count */}
                        <div className="flex flex-col items-center">
                            <div className="text-[10px] text-slate-500 font-bold uppercase">Hand</div>
                            <div className="text-xl font-black text-white flex items-center gap-1">
                                {handCount}
                            </div>
                        </div>
                    </div>
                    {/* Pass Indicator Overlay */}
                    {isPassed && (
                        <div className="absolute inset-0 bg-slate-900/90 flex items-center justify-center rounded-lg border-2 border-red-500 text-red-500 font-bold tracking-widest text-sm animate-bounce-in">PASS</div>
                    )}
                </div>
            </div>
        );

        // --- Components ---
        function App() {
            const [view, setView] = useState('title');
            const [selectedDifficulty, setSelectedDifficulty] = useState('easy');

            const startGame = (diff) => {
                setSelectedDifficulty(diff);
                setView('game');
            };

            return (
                <div className="w-full h-[100dvh] flex flex-col font-sans overflow-hidden">
                    {view === 'title' && <TitleScreen onStart={() => setView('difficulty')} onStats={() => setView('stats')} onRules={() => setView('rules')} />}
                    {view === 'difficulty' && <DifficultySelect onSelect={startGame} onBack={() => setView('title')} />}
                    {view === 'stats' && <StatsScreen onBack={() => setView('title')} />}
                    {view === 'rules' && <RulesScreen onBack={() => setView('title')} />}
                    {view === 'game' && <GameSession difficulty={selectedDifficulty} onExit={() => setView('title')} />}
                </div>
            );
        }

        function TitleScreen({ onStart, onStats, onRules }) {
            return (
                <div className="flex flex-col items-center justify-center h-full animate-bounce-in">
                    <div className="text-6xl sm:text-8xl mb-6 opacity-90">üêß</div>
                    <h1 className="text-4xl sm:text-6xl font-black text-white title-logo mb-10 text-center leading-tight">
                        SILENT<br /><span className="text-cyan-400">PENGUIN</span>
                    </h1>

                    <div className="flex flex-col gap-4 w-64">
                        <Button onClick={onStart} className="bg-cyan-700 hover:bg-cyan-600 text-white">START</Button>
                        <Button onClick={onStats} className="bg-slate-700 hover:bg-slate-600 text-slate-200">STATS</Button>
                        <Button onClick={onRules} className="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white text-sm">HOW TO PLAY</Button>
                    </div>
                    <div className="absolute bottom-4 text-slate-600 text-xs font-mono">v1.0.0</div>
                </div>
            );
        }

        function DifficultySelect({ onSelect, onBack }) {
            return (
                <div className="flex flex-col items-center justify-center h-full animate-bounce-in">
                    <h2 className="text-2xl font-bold mb-8 text-white tracking-wider">SELECT DIFFICULTY</h2>
                    <div className="flex flex-col gap-4 w-full max-w-sm px-4">
                        {Object.entries(DIFFICULTIES).map(([key, config]) => (
                            <button key={key} onClick={() => onSelect(key)} className="group bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-cyan-400 p-4 rounded-lg shadow-lg hover:shadow-cyan-500/20 transition-all text-left flex items-center justify-between">
                                <div><div className={`font-bold text-xl tracking-widest ${config.color}`}>{config.label}</div><div className="text-slate-400 text-xs">{config.desc}</div></div>
                                <div className="text-2xl opacity-0 group-hover:opacity-100 transition-opacity text-cyan-400">‚ñ∂</div>
                            </button>
                        ))}
                    </div>
                    <Button onClick={onBack} className="mt-8 bg-slate-700 hover:bg-slate-600 text-slate-200">BACK</Button>
                </div>
            );
        }

        function StatsScreen({ onBack }) {
            const [stats, setStats] = useState(getStats());
            const handleReset = () => { if (confirm('Reset all stats?')) { clearStats(); setStats(getStats()); } };
            return (
                <div className="flex flex-col items-center justify-center h-full animate-bounce-in p-4">
                    <h2 className="text-3xl font-bold mb-8 text-white tracking-widest">STATISTICS</h2>
                    <div className="bg-slate-800 p-6 rounded-xl shadow-xl w-full max-w-lg border border-slate-700">
                        <div className="grid grid-cols-5 gap-2 mb-4 text-xs font-bold text-slate-400 border-b border-slate-600 pb-2 text-center items-center">
                            <div className="text-left pl-2">LVL</div><div>WIN</div><div>LOSE</div><div>DRAW</div><div>RATE</div>
                        </div>
                        {Object.entries(DIFFICULTIES).map(([key, config]) => {
                            const { wins, losses, draws } = stats[key];
                            const total = wins + losses + draws;
                            const rate = total > 0 ? Math.round((wins / total) * 100) : 0;
                            return (
                                <div key={key} className="grid grid-cols-5 gap-2 py-3 border-b border-slate-700 text-center items-center">
                                    <div className={`text-left pl-2 font-bold ${config.color} text-sm`}>{config.label}</div>
                                    <div className="text-xl">{wins}</div><div className="text-xl">{losses}</div><div className="text-slate-500">{draws}</div>
                                    <div className={`font-bold ${rate >= 50 ? 'text-cyan-400' : 'text-slate-500'}`}>{rate}%</div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex gap-4 mt-8">
                        <Button onClick={onBack} className="bg-slate-700 hover:bg-slate-600 text-slate-200">BACK</Button>
                        <Button onClick={handleReset} className="bg-red-800 hover:bg-red-700 text-red-100">RESET</Button>
                    </div>
                </div>
            );
        }

        function RulesScreen({ onBack }) {
            return (
                <div className="flex flex-col items-center h-full animate-bounce-in p-4 overflow-y-auto w-full">
                    <div className="my-auto flex flex-col items-center w-full max-w-lg">
                        <h2 className="text-3xl font-bold mb-6 text-white tracking-widest flex-shrink-0">ÈÅä„Å≥Êñπ</h2>
                        <div className="bg-slate-800 p-6 rounded-xl shadow-xl w-full border border-slate-700 space-y-6">

                            {/* Rule 1: Basics */}
                            <div className="flex gap-4 items-start">
                                <div className="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-cyan-400 shrink-0">1</div>
                                <div>
                                    <h3 className="font-bold text-white mb-1">„Éî„É©„Éü„ÉÉ„Éâ„Çí‰Ωú„Çã</h3>
                                    <p className="text-sm text-slate-400">„Ç´„Éº„Éâ„ÇíÈÖçÁΩÆ„Åó„Å¶„Éî„É©„Éü„ÉÉ„Éâ„Çí‰Ωú„Å£„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ<span className="text-white font-bold">ÊâãÊú≠„ÇíÂÖ®„Å¶‰Ωø„ÅÑÂàá„Çã„Åì„Å®</span>„ÇíÁõÆÊåá„Åó„Åæ„Åô„ÄÇ</p>
                                    <p className="text-xs text-cyan-400 mt-1">‚Äª ÂÖ®„Å¶‰Ωø„ÅÑÂàá„Çã„Å®<span className="font-bold">PTS„Åå -2</span> „Åï„Çå„Åæ„ÅôÔºà„Éú„Éº„Éä„ÇπÔºâ„ÄÇ</p>
                                </div>
                            </div>

                            {/* Rule 2: Base Row (New) */}
                            <div className="flex gap-4 items-start">
                                <div className="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-cyan-400 shrink-0">2</div>
                                <div>
                                    <h3 className="font-bold text-white mb-1">ÂúüÂè∞„ÅÆ„É´„Éº„É´</h3>
                                    <p className="text-sm text-slate-400">‰∏ÄÁï™‰∏ã„ÅÆÊÆµÔºàÂúüÂè∞Ôºâ„ÅØ<span className="text-white font-bold">7Êûö„Åæ„Åß</span>ÁΩÆ„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Åì„Åì„Å´„ÅØ<span className="text-yellow-400">Â•Ω„Åç„Å™Ëâ≤</span>„ÇíÁΩÆ„Åë„Åæ„Åô„ÄÇ</p>
                                </div>
                            </div>

                            {/* Rule 3: Matching */}
                            <div className="flex gap-4 items-start">
                                <div className="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-cyan-400 shrink-0">3</div>
                                <div className="w-full">
                                    <h3 className="font-bold text-white mb-2">Ëâ≤„ÇíÂêà„Çè„Åõ„Çã</h3>
                                    <div className="bg-slate-900/50 p-3 rounded-lg flex items-center justify-center gap-4 mb-2">
                                        <div className="flex flex-col items-center gap-1">
                                            <div className="flex gap-1">
                                                <Card color="Red" />
                                                <Card color="Blue" />
                                            </div>
                                            <span className="text-[10px] text-slate-500">‰∏ã„ÅÆ2Êûö</span>
                                        </div>
                                        <div className="text-slate-500">‚ûú</div>
                                        <div className="flex gap-4">
                                            <div className="relative flex flex-col items-center">
                                                <Card color="Red" className="mb-1" />
                                                <div className="text-[10px] text-green-400 font-bold">OK</div>
                                                <span className="text-[8px] text-slate-500">(Ëµ§„Å®‰∏ÄËá¥)</span>
                                            </div>
                                            <div className="relative flex flex-col items-center">
                                                <Card color="Yellow" className="opacity-50 mb-1" />
                                                <div className="text-[10px] text-red-500 font-bold">NG</div>
                                                <span className="text-[8px] text-slate-500">(‰∏ÄËá¥„Å™„Åó)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p className="text-sm text-slate-400">‰∏ã„Å´‰∏¶„Çì„Å†2Êûö„ÅÆ„Ç´„Éº„Éâ„ÅÆ<span className="text-cyan-400">„Äå„Å©„Å°„Çâ„Åã„ÅÆËâ≤„Äç</span>„Å®Âêå„Åò„Å™„ÇâÁΩÆ„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</p>
                                </div>
                            </div>

                            {/* Rule 4: Pass */}
                            <div className="flex gap-4 items-start">
                                <div className="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-cyan-400 shrink-0">4</div>
                                <div>
                                    <h3 className="font-bold text-white mb-1">„Éë„Çπ„Å®„Éö„Éä„É´„ÉÜ„Ç£</h3>
                                    <p className="text-sm text-slate-400 mb-1">Âá∫„Åõ„Çã„Ç´„Éº„Éâ„Åå„Å™„ÅÑÊôÇ„ÅØ<span className="text-red-400 font-bold">PASS</span>„Å´„Å™„Çä„ÄÅ„Éö„Éä„É´„ÉÜ„Ç£„Å®„Åó„Å¶<span className="text-white font-bold">PTS</span>Ôºà„ÉÅ„ÉÉ„ÉóÔºâ„Åå<span className="text-red-400">Â¢ó„Åà„Åæ„Åô</span>„ÄÇ</p>
                                    <p className="text-sm font-bold text-red-500 bg-red-900/20 px-2 py-1 rounded inline-block">PTS„Åå 10 „Å´„Å™„Çã„Å®Ë≤†„Åë„Åß„Åô„ÄÇ</p>
                                </div>
                            </div>

                        </div>
                        <Button onClick={onBack} className="mt-8 bg-slate-700 hover:bg-slate-600 text-slate-200 flex-shrink-0">BACK</Button>
                    </div>
                </div>
            );
        }
        function GameSession({ difficulty, onExit }) {
            const [chips, setChips] = useState({ player: 0, cpu: 0 });
            const [roundCount, setRoundCount] = useState(1);
            const [gameStatus, setGameStatus] = useState('intro');
            const [finalResult, setFinalResult] = useState(null);
            const [pyramid, setPyramid] = useState([]);
            const [playerHand, setPlayerHand] = useState([]);
            const [cpuHand, setCpuHand] = useState([]);
            const [dealtCount, setDealtCount] = useState(0);
            const [selectedCardIndex, setSelectedCardIndex] = useState(null);
            const [turn, setTurn] = useState('player');
            const [passed, setPassed] = useState({ player: false, cpu: false });
            const [message, setMessage] = useState("");
            const [perfectTarget, setPerfectTarget] = useState(null); // 'player' | 'cpu' | null
            const [validSlots, setValidSlots] = useState([]);
            const [cameraOffset, setCameraOffset] = useState(0); // number of units to shift
            const initialized = useRef(false);

            useEffect(() => {
                if (!initialized.current) {
                    startRound(1);
                    initialized.current = true;
                }
            }, []);

            // --- Camera Centering Logic ---
            useEffect(() => {
                if (pyramid.length === 0) return;
                const baseRow = pyramid[BASE_ROW_INDEX];
                // Find visible range in the bottom row (including cards and valid slots)
                // We want to center the "action", so existing cards + potential moves in the bottom row
                // However, user asked for "placed cards". Let's stick to placed cards for stability first,
                // perhaps including the very first valid slot if empty.

                const occupiedIndices = baseRow.map((c, i) => c !== null ? i : -1).filter(i => i !== -1);

                let targetCenter = 6; // Default to center of grid (index 6)

                if (occupiedIndices.length > 0) {
                    const minIdx = Math.min(...occupiedIndices);
                    const maxIdx = Math.max(...occupiedIndices);
                    targetCenter = (minIdx + maxIdx) / 2;
                } else if (validSlots.length > 0) {
                    // If no cards, maybe center on the valid slots (initial state)
                    const baseSlots = validSlots.filter(s => s.r === BASE_ROW_INDEX);
                    if (baseSlots.length > 0) {
                        // usually just one at 6 initially
                        const sMin = Math.min(...baseSlots.map(s => s.c));
                        const sMax = Math.max(...baseSlots.map(s => s.c));
                        targetCenter = (sMin + sMax) / 2;
                    }
                }

                // Calculate offset: (Physical Center 6 - Target Center)
                // If Target is 5 (left), we need (6 - 5) = +1 unit shift (move right)
                const offset = 6 - targetCenter;
                setCameraOffset(offset);

            }, [pyramid, validSlots]);

            useEffect(() => {
                if (gameStatus === 'dealing') {
                    if (dealtCount < 14) {
                        const timer = setTimeout(() => { setDealtCount(prev => prev + 1); }, 70);
                        return () => clearTimeout(timer);
                    } else {
                        setTimeout(() => {
                            setGameStatus('playing');
                            const isPlayerStart = roundCount % 2 !== 0;
                            setTurn(isPlayerStart ? 'player' : 'cpu');
                            setMessage("");
                            setPerfectTarget(null);
                        }, 500);
                    }
                }
            }, [gameStatus, dealtCount, roundCount]);

            useEffect(() => {
                if (pyramid.length > 0) setValidSlots(calculateValidSlots(pyramid));
            }, [pyramid]);

            useEffect(() => {
                if (gameStatus !== 'playing') return;
                if ((passed.player || playerHand.length === 0) && (passed.cpu || cpuHand.length === 0)) {
                    if (playerHand.length === 0) {
                        setPerfectTarget('player');
                        setTimeout(finishRound, 1000);
                    } else if (cpuHand.length === 0) {
                        setPerfectTarget('cpu');
                        setTimeout(finishRound, 1000);
                    } else {
                        finishRound();
                    }
                    return;
                }
                if (turn === 'player') {
                    if (playerHand.length === 0 || passed.player) { setTurn('cpu'); return; }
                    if (validSlots.length === 0 && pyramid.length > 0) {
                        if (pyramid[BASE_ROW_INDEX].every(c => c === null)) return;
                    }
                    if (!hasValidMove(playerHand, validSlots, pyramid)) {
                        setPassed(p => ({ ...p, player: true }));
                        setMessage("NO MOVES... PASS");
                        setTimeout(() => setTurn('cpu'), 1500);
                    }
                } else if (turn === 'cpu') {
                    if (cpuHand.length === 0 || passed.cpu) { setTurn('player'); return; }
                    const thinkTime = difficulty === 'hard' ? 1000 : 800;
                    const timer = setTimeout(cpuThinking, thinkTime);
                    return () => clearTimeout(timer);
                }
            }, [turn, validSlots, passed, gameStatus]);

            useEffect(() => {
                if (gameStatus === 'game_over' && finalResult === 'win') {
                    const duration = 3000;
                    const end = Date.now() + duration;
                    const frame = () => {
                        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#EF4444', '#3B82F6', '#EAB308', '#A855F7'] });
                        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#EF4444', '#3B82F6', '#EAB308', '#A855F7'] });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    };
                    frame();
                }
            }, [gameStatus, finalResult]);

            const startRound = (roundNum) => {
                let deck = [];
                Object.keys(COLORS).forEach(c => {
                    for (let i = 0; i < COLORS[c].count; i++) deck.push({ id: Math.random().toString(36).substr(2, 9), color: c });
                });
                deck.sort(() => Math.random() - 0.5);
                const removed = deck.splice(0, 8);
                const pHand = deck.splice(0, 14).sort((a, b) => a.color.localeCompare(b.color));
                const cHand = deck.splice(0, 14);

                const initPyramid = Array.from({ length: PYRAMID_ROWS }, (_, r) =>
                    Array(INTERNAL_BASE_SIZE - (BASE_ROW_INDEX - r)).fill(null)
                );
                setPyramid(initPyramid);
                setValidSlots([{ r: BASE_ROW_INDEX, c: 6 }]);
                setPlayerHand(pHand);
                setCpuHand(cHand);
                setPassed({ player: false, cpu: false });
                setSelectedCardIndex(null);
                setDealtCount(0);
                setMessage("");
                setGameStatus('intro');
                setTimeout(() => setGameStatus('dealing'), 1800);
            };

            const calculateValidSlots = (currentPyramid) => {
                const slots = [];
                const baseRow = currentPyramid[BASE_ROW_INDEX];
                const occupiedIndices = baseRow.map((c, i) => c !== null ? i : -1).filter(i => i !== -1);
                if (occupiedIndices.length === 0) {
                    slots.push({ r: BASE_ROW_INDEX, c: 6 });
                } else {
                    const minIdx = Math.min(...occupiedIndices);
                    const maxIdx = Math.max(...occupiedIndices);
                    if (minIdx > 0 && (maxIdx - (minIdx - 1) + 1) <= BASE_WIDTH_LIMIT) slots.push({ r: BASE_ROW_INDEX, c: minIdx - 1 });
                    if (maxIdx < baseRow.length - 1 && ((maxIdx + 1) - minIdx + 1) <= BASE_WIDTH_LIMIT) slots.push({ r: BASE_ROW_INDEX, c: maxIdx + 1 });
                }
                for (let r = 0; r < BASE_ROW_INDEX; r++) {
                    for (let c = 0; c < currentPyramid[r].length; c++) {
                        if (currentPyramid[r][c] !== null) continue;
                        const l = currentPyramid[r + 1][c];
                        const rP = currentPyramid[r + 1][c + 1];
                        if (l && rP) slots.push({ r, c });
                    }
                }
                return slots;
            };

            const isColorMatch = (r, c, cardColor) => {
                if (r === BASE_ROW_INDEX) return true;
                if (!pyramid[r + 1]) return false;
                const l = pyramid[r + 1][c];
                const rP = pyramid[r + 1][c + 1];
                if (!l || !rP) return false;
                return (cardColor === l.color || cardColor === rP.color);
            };

            const hasValidMove = (hand, slots, currentPyramid) => {
                return hand.some(card => slots.some(slot => isColorMatch(slot.r, slot.c, card.color)));
            };

            const triggerPlaceEffect = (r, c, color) => {
                const colorMap = {
                    Green: '#22c55e', Red: '#ef4444', Blue: '#3b82f6', Yellow: '#eab308', Purple: '#a855f7'
                };
                // Á∞°ÊòìÁöÑ„Å™‰ΩçÁΩÆË®àÁÆó (ÁîªÈù¢‰∏≠Â§Æ‰ªòËøë„ÇíÂü∫Ê∫ñ„Å´Â∞ë„ÅóÊï£„Çâ„Åô)
                // Êú¨Êù•„ÅØelement„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó„Åô„Åπ„Åç„Å†„Åå„ÄÅReactÂÜÖ„Åß„ÅÆÁ∞°ÊòìÂÆüË£Ö„Å®„Åó„Å¶‰∏≠Â§Æ„Åã„ÇâÂ∞ë„Åó„Åö„Çâ„Åô
                const yPos = r / 7; // ‰∏ä„ÅÆÊñπ„Åª„Å©0„Å´Ëøë„ÅÑ
                const xPos = 0.5; // ‰∏≠Â§Æ

                confetti({
                    particleCount: 20,
                    spread: 50,
                    origin: { y: 0.3 + (yPos * 0.4), x: 0.5 },
                    colors: [colorMap[color]],
                    gravity: 1.2,
                    scalar: 0.8,
                    shapes: ['circle']
                });
            };

            const placeCard = (r, c, card, who, handIndex) => {
                const newPyramid = [...pyramid];
                newPyramid[r] = [...newPyramid[r]];
                newPyramid[r][c] = card;
                setPyramid(newPyramid);
                triggerPlaceEffect(r, c, card.color);

                if (who === 'player') {
                    const newHand = playerHand.filter((_, i) => i !== handIndex);
                    setPlayerHand(newHand);
                    setDealtCount(prev => prev - 1);
                    setSelectedCardIndex(null);
                    setTurn('cpu');
                } else {
                    const newHand = cpuHand.filter((_, i) => i !== handIndex);
                    setCpuHand(newHand);
                    setTurn('player');
                }
            };

            const handlePlayerClick = (r, c) => {
                if (turn !== 'player' || selectedCardIndex === null || gameStatus !== 'playing') return;
                const card = playerHand[selectedCardIndex];
                if (!validSlots.some(s => s.r === r && s.c === c)) return;
                if (!isColorMatch(r, c, card.color)) { setMessage("Wrong Color"); return; }
                placeCard(r, c, card, 'player', selectedCardIndex);
            };

            const cpuThinking = () => {
                let candidates = [];
                validSlots.forEach(slot => {
                    cpuHand.forEach((card, hIdx) => {
                        if (isColorMatch(slot.r, slot.c, card.color)) {
                            let score = slot.r * 10;
                            if (difficulty === 'easy') score = Math.random();
                            else if (difficulty === 'normal') score += Math.random() * 5;
                            else if (difficulty === 'hard') {
                                const myColors = {};
                                cpuHand.forEach(c => myColors[c.color] = (myColors[c.color] || 0) + 1);
                                score += (myColors[card.color] || 0) * 5;
                            }
                            candidates.push({ slot, card, hIdx, score });
                        }
                    });
                });
                if (candidates.length === 0) {
                    setPassed(p => ({ ...p, cpu: true }));
                    setMessage("CPU PASS");
                    setTimeout(() => setTurn('player'), 1500);
                    return;
                }
                candidates.sort((a, b) => b.score - a.score);
                const topN = difficulty === 'easy' ? candidates.length : (difficulty === 'normal' ? 3 : 1);
                const choice = candidates[Math.floor(Math.random() * Math.min(topN, candidates.length))];
                placeCard(choice.slot.r, choice.slot.c, choice.card, 'cpu', choice.hIdx);
            };

            const finishRound = () => {
                setPerfectTarget(null);
                setGameStatus('round_over');
                const pPen = playerHand.length === 0 ? -2 : playerHand.length;
                const cPen = cpuHand.length === 0 ? -2 : cpuHand.length;
                const nextP = Math.max(0, chips.player + pPen);
                const nextC = Math.max(0, chips.cpu + cPen);
                setChips({ player: nextP, cpu: nextC });

                if (nextP >= LOSE_THRESHOLD || nextC >= LOSE_THRESHOLD) {
                    setTimeout(() => {
                        let res = 'draw';
                        if (nextP < nextC) res = 'win'; else if (nextP > nextC) res = 'loss';
                        setFinalResult(res);
                        saveGameResult(difficulty, res);
                        setGameStatus('game_over');
                        if (res === 'win') triggerConfetti();
                    }, 1500);
                }
            };


            return (
                <div className="flex flex-col items-center h-full relative bg-slate-900 text-white">
                    <div className="max-w-4xl w-full mx-auto relative flex flex-col h-full overflow-hidden shadow-2xl">
                        <header className="flex justify-between items-center p-4 z-40 relative">
                            <ChipView
                                count={chips.player}
                                handCount={playerHand.length}
                                label="YOU"
                                isDanger={chips.player >= LOSE_THRESHOLD - 5}
                                isActive={turn === 'player' && gameStatus === 'playing'}
                                isPassed={passed.player}
                            />
                            <div className="text-center flex flex-col items-center">
                                <div className="text-xs font-bold text-slate-500 mt-1 tracking-widest">ROUND {roundCount}</div>
                                <button onClick={onExit} className="text-[10px] text-slate-600 hover:text-red-400 font-bold tracking-widest mt-1 border border-transparent hover:border-red-400/30 rounded-md px-2 transition-all">EXIT</button>
                            </div>
                            <ChipView
                                count={chips.cpu}
                                handCount={cpuHand.length}
                                label="CPU"
                                isDanger={chips.cpu >= LOSE_THRESHOLD - 5}
                                isActive={turn === 'cpu' && gameStatus === 'playing'}
                                isCpu={true}
                                isPassed={passed.cpu}
                            />
                        </header>

                        {/* Message / Status Area */}
                        {(message || passed.player || passed.cpu) && (
                            <div className="absolute top-32 pointer-events-none z-30 w-full flex justify-center">
                                <div className="text-xl font-bold text-yellow-300 drop-shadow-md animate-text-pop bg-slate-900/80 px-4 py-1 rounded-full border border-yellow-500/50">
                                    {message || (passed.player && passed.cpu ? "BOTH PASS!" : (passed.player ? "YOU PASS" : (passed.cpu ? "CPU PASS" : "")))}
                                </div>
                            </div>
                        )}

                        <div className="flex-1 w-full flex flex-col items-center p-2 overflow-hidden relative bg-slate-800/50">
                            {gameStatus === 'intro' && (
                                <div className="absolute inset-0 z-50 flex items-center justify-center pointer-events-none">
                                    <div className="text-6xl font-black text-white drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)] animate-text-pop tracking-widest text-center">
                                        <span className="block text-2xl text-cyan-400 mb-2">ROUND {roundCount}</span>
                                        START
                                    </div>
                                </div>
                            )}

                            {/* Removed CPU hand display */}

                            <div
                                className="pyramid-container flex-1 w-full flex flex-col justify-center items-center mb-1 scale-90 sm:scale-100 origin-center transition-all duration-500 ease-in-out transform"
                                style={{
                                    opacity: gameStatus === 'intro' ? 0 : 1,
                                    '--tw-translate-x': `calc(${cameraOffset} * var(--card-unit-width, 2.5rem))`,
                                    '--card-unit-width': '2.5rem' // Default (mobile)
                                }}
                            >
                                {/* Media query handling for unit width override */}
                                <style>{`
                                    @media (min-width: 640px) {
                                        .pyramid-container { --card-unit-width: 3.75rem !important; }
                                    }
                                `}</style>

                                {pyramid.map((row, r) => (
                                    <div key={r} className="flex justify-center">
                                        {row.map((card, c) => {
                                            const isValid = validSlots.some(s => s.r === r && s.c === c);
                                            // „Çπ„Éû„Éº„Éà„Ç¨„Ç§„Éâ: „Ç´„Éº„ÉâÈÅ∏Êäû‰∏≠„ÅØ„ÄÅ„Åù„ÅÆ„Ç´„Éº„Éâ„ÅåÁΩÆ„Åë„ÇãÂ†¥ÊâÄ„Å†„Åë„Çí„Éè„Ç§„É©„Ç§„Éà
                                            const isGuideActive = selectedCardIndex !== null;
                                            const canPlaceSelected = isGuideActive ? (isValid && isColorMatch(r, c, playerHand[selectedCardIndex].color)) : isValid;

                                            return (
                                                <div key={`${r}-${c}`} className="relative w-9 h-12 sm:w-14 sm:h-20 mx-0.5 grid-cell">
                                                    {card ? (
                                                        <div className={`w-full h-full rounded border-2 border-white ${COLORS[card.color].bg} card-shadow flex items-center justify-center animate-pop-in`}>
                                                            <span className="text-xl sm:text-2xl drop-shadow">üêß</span>
                                                            <span className="absolute bottom-1 right-1 text-xs sm:text-sm opacity-50">{COLORS[card.color].icon}</span>
                                                        </div>
                                                    ) : (
                                                        (canPlaceSelected && turn === 'player' && gameStatus === 'playing') ? (
                                                            <div onClick={() => isGuideActive ? handlePlayerClick(r, c) : null} className={`w-full h-full rounded cursor-pointer valid-zone flex items-center justify-center text-xs text-slate-300 ${isGuideActive ? 'border-yellow-400 bg-yellow-400/20' : ''}`}>{isGuideActive ? 'HERE' : ''}</div>
                                                        ) : <div className="w-full h-full opacity-0"></div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ))}
                            </div>


                            {perfectTarget && (
                                <div className="absolute inset-0 z-50 pointer-events-none flex flex-col items-center justify-center animate-bounce-in bg-slate-900/40 backdrop-blur-sm">
                                    <div className="text-4xl sm:text-6xl font-black text-yellow-300 drop-shadow-[0_0_10px_rgba(234,179,8,0.8)] tracking-widest stroke-black">PERFECT!</div>
                                    <div className="text-2xl sm:text-4xl font-bold text-cyan-400 bg-slate-900/90 px-6 py-2 rounded-full border-2 border-cyan-400 mt-4 shadow-xl">-2 PTS</div>
                                </div>
                            )}

                            {gameStatus === 'round_over' && (
                                <div className="absolute inset-0 bg-slate-900/90 z-40 flex items-center justify-center animate-bounce-in">
                                    <div className="text-center">
                                        <h2 className="text-2xl font-bold mb-8 tracking-widest text-slate-300">ROUND RESULT</h2>
                                        <div className="flex gap-12 justify-center mb-10">
                                            <div><div className="text-xs text-slate-400 font-bold mb-1">YOU</div><div className="text-4xl font-black text-red-400">+{Math.max(0, playerHand.length === 0 ? -2 : playerHand.length)}</div></div>
                                            <div><div className="text-xs text-slate-400 font-bold mb-1">CPU</div><div className="text-4xl font-black text-red-400">+{Math.max(0, cpuHand.length === 0 ? -2 : cpuHand.length)}</div></div>
                                        </div>
                                        <Button onClick={() => { setRoundCount(p => p + 1); startRound(roundCount + 1); }} className="bg-cyan-600 hover:bg-cyan-500 text-white px-8">NEXT ROUND</Button>
                                    </div>
                                </div>
                            )}
                            {gameStatus === 'game_over' && (
                                <div className="absolute inset-0 bg-slate-900/95 z-50 flex items-center justify-center animate-bounce-in">
                                    <div className="bg-slate-800 p-8 rounded-2xl border-2 border-cyan-500 shadow-2xl text-center max-w-sm w-full">
                                        <div className={`text-6xl mb-4 ${finalResult === 'win' ? 'animate-jump' : ''}`}>üêß</div>
                                        <h2 className="text-4xl font-black mb-2 text-white italic">{finalResult === 'win' ? 'VICTORY' : (finalResult === 'loss' ? 'DEFEAT' : 'DRAW')}</h2>
                                        <div className="w-16 h-1 bg-cyan-500 mx-auto mb-6"></div>
                                        <div className="flex justify-between px-8 mb-8 font-bold text-xl">
                                            <div className="text-center"><div>YOU</div><div className="text-3xl text-cyan-400">{chips.player}</div></div>
                                            <div className="text-center"><div>CPU</div><div className="text-3xl text-cyan-400">{chips.cpu}</div></div>
                                        </div>
                                        <Button onClick={onExit} className="w-full bg-slate-700 hover:bg-slate-600 text-slate-200">TITLE</Button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className={`w-full bg-slate-900 p-3 border-t border-slate-700 transition-all duration-300 z-50 pb-[calc(env(safe-area-inset-bottom)+1.5rem)] ${(turn !== 'player' || gameStatus !== 'playing') ? 'translate-y-2 opacity-90 grayscale' : ''}`}>
                            <div className="grid grid-cols-7 gap-2 justify-items-center max-w-lg mx-auto min-h-[7rem]">
                                {playerHand.map((card, idx) => {
                                    if (idx >= dealtCount) return null;
                                    return (
                                        <div key={card.id} onClick={() => turn === 'player' && gameStatus === 'playing' && setSelectedCardIndex(idx)}
                                            className={`
                                            relative w-10 h-14 sm:w-12 sm:h-16 rounded cursor-pointer border-2 border-white ${COLORS[card.color].bg} card-shadow 
                                            ${selectedCardIndex === idx ? 'selected' : 'hover:-translate-y-2'}
                                            animate-slide-up flex items-center justify-center
                                        `}
                                            style={{ transition: 'transform 0.1s' }}
                                        >
                                            <span className="text-white drop-shadow-md text-lg">{COLORS[card.color].icon}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>